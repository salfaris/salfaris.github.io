<!DOCTYPE html>

<html lang="en">
<head>
<!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://salfaris.github.io/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
<link href="https://salfaris.github.io/theme/css/style.css" rel="stylesheet" type="text/css"/>
<link href="https://salfaris.github.io/theme/css/pygments.css" rel="stylesheet" type="text/css"/>
<link href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono" rel="stylesheet" type="text/css"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="Salman Faris" name="author"/>
<meta content="Your 6 minute stop to read about math, machine learning and python." name="description"/>
<meta content="summary" name="twitter:card">
<link href="https://salfaris.github.io/feeds/all.atom.xml" rel="alternate" title="Salman Faris Atom" type="application/atom+xml">
<meta content="python, testing, software-engineering" name="keywords"/>
<meta content="Unit Testing with pytest" property="twitter:title">
<meta content="https://salfaris.github.io/images/header-unit-testing-with-pytest.png" property="twitter:image">
<title>
    Salman Faris
â€“ Unit Testing with pytest  </title>
</meta></meta></link></meta><link href="https://salfaris.github.io/unit-testing-with-pytest.html" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Salman Faris", "item": "https://salfaris.github.io"}, {"@type": "ListItem", "position": 2, "name": "Unit testing with pytest", "item": "https://salfaris.github.io/unit-testing-with-pytest.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Salman Faris"}, "publisher": {"@type": "Organization", "name": "Salman Faris"}, "headline": "Unit Testing with pytest", "about": "python", "datePublished": "2021-05-03 12:36", "image": "images/header-unit-testing-with-pytest.png"}</script></head>
<body>
<aside>
<div id="user_meta">
<a href="https://salfaris.github.io">
<img alt="logo" src="https://salfaris.github.io/images/avatar_circ.png"/>
</a>
<h2><a href="https://salfaris.github.io">Salman Faris</a></h2>
<p>I talk about math, machine learning and python.</p>
<ul>
<!-- <li><a href="https://salfaris.github.io">blog</a></li> -->
<li><a href="https://salfaris.github.io/pages/about.html">about</a></li>
<li><a href="https://salfaris.github.io/pages/resources.html">resources</a></li>
</ul>
</div>
</aside>
<main>
<header>
<p>
<a href="https://salfaris.github.io">Index</a> Â¦ <a href="https://salfaris.github.io/archives.html">Archives</a>
      Â¦ <a href="https://salfaris.github.io/feeds/all.atom.xml">Atom</a>
</p>
</header>
<article>
<div class="article_title">
<h1><a href="https://salfaris.github.io/unit-testing-with-pytest.html">Unit Testing with pytest</a></h1>
</div>
<div class="article_meta">
<p>Posted on: Mon 03 May 2021</p>
</div>
<div class="article_text">
<p><img alt="Post header" src="https://salfaris.github.io/images/header-unit-testing-with-pytest.png"/></p>
<p>It is a common scene that we want to test our functions after we've done writing them. In Python, we can usually do this by printing to the console. For example, suppose we are interested in testing the following function:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_positive</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">"""Add two positive integers x and y. If the sum</span>
<span class="sd">     is negative or zero, return None."""</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div>
<p>which returns the sum of the two integers <code>x</code> and <code>y</code> if the output is strictly positive, or else return <code>None</code>. Since we are adding two <strong>positive integers</strong>, we expect that the <code>add_positive</code> function returns a positive integer as well. So we can try a few pairs, say, <code>add_positive(2, 3)</code> and <code>add_positive(1, 1)</code>, and we expect these to return 5 and 2 respectively; both greater than 0. If we try <code>add_positive(-1, -5)</code>, then this should return <code>None</code> as it yields -6 instead which is less than 0. If we want to test our function with multiple inputs, we can do something like a <code>for</code> loop. So maybe something like:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="o">...</span><span class="p">]:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">add_positive</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div>
<p>which should yield</p>
<div class="highlight"><pre><span></span><code>&gt;&gt; <span class="m">5</span>
&gt;&gt; <span class="m">2</span>
&gt;&gt; None
&gt;&gt; <span class="m">190</span>
</code></pre></div>
<p>and then we eyeball each of the output to see if it as expected. </p>
<p>This is of course a correct way to do it as we can evaluate whether the output on the console is as expected; but is it efficient? </p>
<h2>ðŸ§  Why unit testing is a no-brainer</h2>
<p>In a typical life cycle of a function, there are three situations where we would want to test our functions:</p>
<ol>
<li>The <strong>first time</strong> it is implemented.</li>
<li><strong>When a test fails</strong>, we fix the bug, and then we have to redo testing.</li>
<li>When implementing a <strong>new feature</strong> or <strong>refactoring code</strong>.</li>
</ol>
<p>Imagine how many times we would have to manually test this function. If it would take 3 minutes per (manual) test, and if we would have to do it 100 times over the function's whole life cycle, then we would have effectively spent 3 x 100 = 300 minutes, which is roughly <strong>5 hours of testing</strong>! Now if we have 10 functions to test, it would take us 50 hours or roughly <strong>2 days worth of time to test these functions</strong>! I don't know about you, but that sounds like a lot of time to me for only 10 functions. This is why we would want to automate the testing process by writing unit tests, which, together with the planning phase, requires about an hour to write in perpetuity (in theory).</p>
<blockquote>
<blockquote>
<p>Manually testing a function throughout its whole life cycle may take you 5 hours; whereas writing a properly planned unit test may take you only an hour, and this is one-fifth of the former.</p>
</blockquote>
</blockquote>
<p>There are a variety of Python libraries to do unit testing, some of which are:</p>
<ol>
<li><code>pytest</code></li>
<li><code>unittest</code></li>
<li><code>nosetests</code></li>
<li><code>doctest</code></li>
</ol>
<h2>ðŸ§ª Basic unit testing procedure</h2>
<p>In this post, we will look at <code>pytest</code> because it is simply the most popular (hence, a lot of support, say, on StackOverflow) and easiest to use. We start by installing <code>pytest</code> if it's not already installed:</p>
<div class="highlight"><pre><span></span><code>pip install pytest
</code></pre></div>
<h3>Step 1: Creating the test module</h3>
<p>Assume that the <code>add_positive()</code> function lies in a module called <code>add_positive.py</code>. We begin the unit testing process by creating a file called <code>test_add_positive.py</code> in the same directory as <code>add_positive.py</code>. Such a file will contain the unit tests of functions in <code>add_positive.py</code>, and is called a <strong>test module</strong>. The <code>test_</code> in front of <code>test_add_positive.py</code> is important as it lets <code>pytest</code> knows that this is a file containing unit tests.</p>
<p><em>Remark: The test module for the module <code>add_positive.py</code> does not have to be named <code>test_add_positive.py</code>. You can name it <code>test_x.py</code> or <code>test_covid.py</code> or whatever as long as it is prepended with <code>test_</code>. But it is good practice to follow the naming convention of <code>test_module_name</code> to trace which module is this test module testing.</em></p>
<h3>Step 2: Importing inside the test module</h3>
<p>The next step is to (mainly) import two things:</p>
<ol>
<li>The <code>pytest</code> module;</li>
<li>and the module (or function) we want to test.</li>
</ol>
<p>So at the top of our test module <code>test_add_positive.py</code>, we would have:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">add_positive</span> <span class="kn">import</span> <span class="n">add_positive</span>
</code></pre></div>
<h3>Step 3: Begin writing unit tests</h3>
<p>A unit test is basically a Python function, no more and no less. The only thing special about a unit test is that it is prepended by <code>test_</code> in its name. This is just to tell <code>pytest</code> to use it as part of the testing procedure. Here is an example of a unit test declaration:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_for_positive_pairs</span><span class="p">():</span>
    <span class="o">...</span>
</code></pre></div>
<p>Inside the body of a unit test are <strong>assertions</strong>, and this is the actual testing process. We want to test if our <code>add_positive()</code> function returns correctly if positive pairs (<code>x</code>, <code>y</code>) are passed into the function. So we assert the following:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_for_positive_pairs</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="mi">99999</span><span class="p">,</span> <span class="mi">99999</span><span class="p">)</span> <span class="o">==</span> <span class="mi">199998</span>
</code></pre></div>
<p>How about if we want to add a second unit test which tests when a zero pair i.e. (0, 0) is passed into the function? Well we just write another function right below it. We expect <code>add_positive(0, 0)</code> to return None, so we write exactly that:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_for_positive_pairs</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="mi">99999</span><span class="p">,</span> <span class="mi">99999</span><span class="p">)</span> <span class="o">==</span> <span class="mi">199998</span>

<span class="k">def</span> <span class="nf">test_for_zero_pair</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>
<p>I would like to add two more tests which test the <code>add_positive</code> function when negative and mixed pairs are fed into the function. The whole test module should now look something like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">add_positive</span> <span class="kn">import</span> <span class="n">add_positive</span>

<span class="k">def</span> <span class="nf">test_for_positive_pairs</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="mi">99999</span><span class="p">,</span> <span class="mi">99999</span><span class="p">)</span> <span class="o">==</span> <span class="mi">199998</span>

<span class="k">def</span> <span class="nf">test_for_negative_pairs</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">test_for_zero_pair</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">test_for_mixed_pairs</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">add_positive</span><span class="p">(</span><span class="o">-</span><span class="mi">900</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>
<p><em>Remark: Note that you can get as creative as you'd like with the values you're testing. It is good practice to always consider edge cases in the unit test, but this is a topic of a later post.</em></p>
<h3>Step 4: Running pytest and reading the test report</h3>
<p>Once you're done with writing the test module, testing is as easy as opening your terminal, <code>cd</code>-ing into the directory containing the test module, and executing:</p>
<div class="highlight"><pre><span></span><code>pytest test_add_positive.py
</code></pre></div>
<p>If the implementation of <code>add_positive()</code> is correct (with respect to our tests), you should see a test report like this.</p>
<p><img alt="Unit-test-pass" src="https://salfaris.github.io/images/unit-test-1.png"/></p>
<p>Just ignore everything above "collected 4 items" as it is not too important. The breakdown of this test report is the following:</p>
<ul>
<li>"Collected 4 items" means that we will be executing 4 unit tests.</li>
<li>The 4 green dots indicates that we have pass all 4 of them, and they are sequential (see what happens when 1 fail below).</li>
<li>The obvious "4 passed in 0.02s" message is the summary.</li>
</ul>
<h2>ðŸ“Œ Why unit tests are important in prod</h2>
<p>Three months after the <code>add_positive.py</code> code has been deployed, your colleague Gilfoyle modified the <code>add_positive()</code> function returning only the sum:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_positive</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">"""Add two positive integers x and y. If the sum</span>
<span class="sd">     is negative or zero, return None."""</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</code></pre></div>
<p>Apparently, he didn't read the short description of the function; he thought that you're adding an unnecesary check. However, the function is supposed to work like that â€“ only returning if the sum is positive (think of another module which relies on the correctness of this function). </p>
<p>If there were no unit tests written to check this modification, this seemingly trivial edit by Gilfoyle could have been merged into the main branch and could possibly crash the whole system! Thankfully, we implemented continuous integration and upon making a pull request, Gilfoyle was bombarded with the following test report:</p>
<p><img alt="Unit-test-fail" src="https://salfaris.github.io/images/unit-test-2.png"/></p>
<p>Here is a breakdown of the report:</p>
<ul>
<li>"Collected 4 items" means the same as before.</li>
<li>The first green dot means we passed the first unit test, but the subsequent F's means we failed the second, third and fourth unit test;</li>
<li>this is reflected in the FAILURES section below it, showing which exact lines contribute to these failures.</li>
<li>The "3 failed, 1 passed in 0.19s" message is the summary.</li>
</ul>
<p>Sometimes, we just want to run the test up until the first failure. This can be done by adding a <code>-x</code> flag like so:</p>
<div class="highlight"><pre><span></span><code>pytest -x test_add_positive.py
</code></pre></div>
<p>Now you might be wondering, what to do if we have multiple functions to test in the same module given that this one single <code>add_positive</code> function alone requires 4 unit tests. Things can start getting really messy right? To solve this issue, we can create a class containing these unit tests for each function we want to test. This will be a topic of a future post on testing, thanks for reading.</p>
</div>
<div class="article_meta">
<p>Category: <a href="https://salfaris.github.io/category/python.html">python</a>
 â€“ Tags:
      <a href="https://salfaris.github.io/tag/python.html">python</a>,      <a href="https://salfaris.github.io/tag/testing.html">testing</a>,      <a href="https://salfaris.github.io/tag/software-engineering.html">software-engineering</a> </p>
</div>
<div id="article_comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
        var disqus_identifier = "unit-testing-with-pytest.html";
        (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = '//salfaris.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
    </script>
</div>
</article>
<div id="ending_message">
<p>Â© Salman Faris. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
</div>
</main>
</body>
</html>
<!-- This script solves the issue of mathjax not rendering on homepage -->
<script async="" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML" type="text/javascript">
</script>