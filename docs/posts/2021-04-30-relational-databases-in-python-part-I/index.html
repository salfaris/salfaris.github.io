<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Salman Faris">
<meta name="dcterms.date" content="2021-04-30">

<title>salman faris - Relational Databases in Python (part I)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta name="twitter:title" content="salman faris - Relational Databases in Python (part I)">
<meta name="twitter:description" content="We usually hear the word databases being thrown around especially when talking about data-related things. So what is it, and what is the more precise term relational databases?">
<meta name="twitter:image" content="https://salfaris.github.io/posts/2021-04-30-relational-databases-in-python-part-I/header-relational-databases-in-python-part-I.png">
<meta name="twitter:image-height" content="720">
<meta name="twitter:image-width" content="1920">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title"><strong>salman faris</strong></span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">about</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html">
 <span class="menu-text">projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resources.html">
 <span class="menu-text">resources</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/salfaris/"><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/salfaris"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Relational Databases in Python (part I)</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">data science</div>
                <div class="quarto-category">python</div>
                <div class="quarto-category">sql</div>
                <div class="quarto-category">sqlalchemy</div>
                <div class="quarto-category">databases</div>
                <div class="quarto-category">data handling</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Salman Faris </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 30, 2021</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">April 30, 2021</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction-to-sqlalchemy" id="toc-introduction-to-sqlalchemy" class="nav-link active" data-scroll-target="#introduction-to-sqlalchemy">Introduction to SQLAlchemy</a></li>
  <li><a href="#talking-to-a-database-first-steps" id="toc-talking-to-a-database-first-steps" class="nav-link" data-scroll-target="#talking-to-a-database-first-steps">💬 Talking to a database, first steps</a>
  <ul class="collapse">
  <li><a href="#step-1-create-an-engine" id="toc-step-1-create-an-engine" class="nav-link" data-scroll-target="#step-1-create-an-engine">Step 1: Create an engine</a></li>
  <li><a href="#step-2-establish-a-connection" id="toc-step-2-establish-a-connection" class="nav-link" data-scroll-target="#step-2-establish-a-connection">Step 2: Establish a connection</a></li>
  <li><a href="#step-3-checking-table-names" id="toc-step-3-checking-table-names" class="nav-link" data-scroll-target="#step-3-checking-table-names">Step 3: Checking table names</a></li>
  </ul></li>
  <li><a href="#querying-the-database-using-sqlalchemy" id="toc-querying-the-database-using-sqlalchemy" class="nav-link" data-scroll-target="#querying-the-database-using-sqlalchemy">📝 Querying the database using SQLAlchemy</a>
  <ul class="collapse">
  <li><a href="#raw-sql-queries-resultproxy-and-resultset" id="toc-raw-sql-queries-resultproxy-and-resultset" class="nav-link" data-scroll-target="#raw-sql-queries-resultproxy-and-resultset">Raw SQL queries, ResultProxy and ResultSet</a></li>
  <li><a href="#working-with-resultset" id="toc-working-with-resultset" class="nav-link" data-scroll-target="#working-with-resultset">Working with ResultSet</a></li>
  <li><a href="#sqlalchemy-queries" id="toc-sqlalchemy-queries" class="nav-link" data-scroll-target="#sqlalchemy-queries">SQLAlchemy queries</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="header-relational-databases-in-python-part-I.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Post header</figcaption><p></p>
</figure>
</div>
<p>We usually hear the word <em>databases</em> being thrown around especially when talking about data-related things. So what is it, and what is the more precise term <em>relational databases</em>?</p>
<p>A relational database is like an Excel file. It is made up of <strong>tables</strong> (note that this is plural) which holds data in the form of columns and rows. In the Excel analogy, tables are basically <em>sheets</em>. Moreover, tables can be <em>related</em> to each other but they need a column to act as a bridge linking them. Such a column is usually called a <strong>key</strong> (either primary key or foreign key). This feature of being related explains the <em>relational</em> term in relational databases. Relational databases is part of the <strong>relational model</strong> which is a much more general framework of structuring and handling data management.</p>
<p><em>From now on, we shall simply refer to relational databases as just databases.</em></p>
<section id="introduction-to-sqlalchemy" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-sqlalchemy">Introduction to SQLAlchemy</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install sqlalchemy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Great, we now know what databases are, but how do we work with them? If this is an Excel file, we just open it and the rest is obvious (at least we think it’s obvious because we’re used to working with it). How do we open and interact with a database? There are many ways to do this and there’s no one right way. For example, you can work directly with SQLite or MySQL in the command line but things can really get messy if you do it this way.</p>
<p>If you’re using Python, then enter <strong>SQLAlchemy</strong>! SQLAlchemy gives you the power of interacting with databases using SQL queries straight from Python. Plus, it helps us abstract away complex queries and the difference in databases (remember that there are a lot of popular databases e.g.&nbsp;MySQL, PostgreSQL and Oracle with subtle differences among them). So querying databases becomes cleaner (and more exciting?) via SQLAlchemy. To <strong>install SQLAlchemy</strong> is as easy as executing the line of code you see below this section’s title in your favorite terminal. If you’re using Anaconda, then it is already shipped and ready to use!</p>
<p>Additional notes:</p>
<ul>
<li><p><em>This is not an excuse to not learn writing raw SQL queries because understanding SQL is still important when working with tools like SQLAlchemy!</em></p></li>
<li><p><em>Those of you who have built web applications with Flask or Django might realize that we usually handle data using an object-oriented approach – using so-called data models. This is the Object Relational Model (ORM) approach, which is one of the two main components of SQLAlchemy. The other main component is called the “core part” of SQLAlchemy which is really centred around the relational model of the database. The latter is the one that we will be focusing on in this post today.</em></p></li>
</ul>
</section>
<section id="talking-to-a-database-first-steps" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-a-database-first-steps">💬 Talking to a database, first steps</h2>
<section id="step-1-create-an-engine" class="level3">
<h3 class="anchored" data-anchor-id="step-1-create-an-engine">Step 1: Create an engine</h3>
<p>To write something on a paper, you would need a pencil. To turn the lights on, you would need to switch the toggle. <em>To interact with a database, you would need a so-called</em> <strong>engine</strong>.</p>
<p>In theory, a database relies on this engine just like how a car would rely on its (car) engine. But I found that thinking of this engine as a mediator rather than a literal engine is much easier to digest.</p>
<p>To create an engine, you first have to import the <code>create_engine</code> function from <code>sqlalchemy</code>. Then, you need to pass in a <strong>connection string</strong> which in its simplest form specifies two things: (i) the database you want to talk to, and (ii) the path to the database. For example, if I want to connect to <code>race_data.db</code> which is a SQLite database in my current directory, the connection string would be <code>"sqlite:///race_data.db"</code>. So together, they would look something like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>engine <span class="op">=</span> create_engine(<span class="st">"sqlite:///race_data.db"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p><strong>Key terms</strong></p>
<ol type="1">
<li>The <strong>engine</strong> is a mediator for SQLAlchemy to interact with a database.</li>
<li>A <strong>connection string</strong> specifies the details of the database we want to interact with.</li>
</ol>
</blockquote>
</section>
<section id="step-2-establish-a-connection" class="level3">
<h3 class="anchored" data-anchor-id="step-2-establish-a-connection">Step 2: Establish a connection</h3>
<p>In the previous step, we have simply created an engine but have yet to <strong>connect</strong> to it! To establish a connection, you can simply invoke another one-liner:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>connection <span class="op">=</span> engine.<span class="ex">connect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>One thing worth pointing out is that SQLAlchemy is clever enough to not actually make a connection until we pass in some queries for it to execute.</p>
</section>
<section id="step-3-checking-table-names" class="level3">
<h3 class="anchored" data-anchor-id="step-3-checking-table-names">Step 3: Checking table names</h3>
<p>Recall that tables are to databases just like sheets are to Excel files. So you’d want to know what tables (not columns of a table, yet!) are available before making queries. To do this, you can simply execute</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(engine.table_names())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to get a list of available tables to work with. For me, this returns</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="ex">[</span><span class="st">'race_table'</span><span class="ex">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which means that I have only one table named <code>'race_table'</code>. In practice, you would usually have a few tables.</p>
</section>
</section>
<section id="querying-the-database-using-sqlalchemy" class="level2">
<h2 class="anchored" data-anchor-id="querying-the-database-using-sqlalchemy">📝 Querying the database using SQLAlchemy</h2>
<p>From now on, we assume that we have instantiated an <code>engine</code> and <code>connection</code> object exactly like what we did previously.</p>
<section id="raw-sql-queries-resultproxy-and-resultset" class="level3">
<h3 class="anchored" data-anchor-id="raw-sql-queries-resultproxy-and-resultset">Raw SQL queries, ResultProxy and ResultSet</h3>
<p>Recall that we use the SQL language to make CRUD operations – create, read, update and delete. If you are not familiar with this, I highly recommend that you learn a bit of SQL after reading this - my recommendation is <a href="https://www.mikedane.com/databases/sql/">Mike Dane’s</a>{:target=“_blank”} free and complete SQL course, from installing MySQL to joining tables. However, for now, it is sufficient to know the “Hello World” of SQL – which is <code>SELECT * FROM this_table</code> where <code>this_table</code> is some table in the database. The query <code>SELECT * FROM this_table</code> does exactly what you expect it to do, it selects every possible row (symbolized by the asterisk <code>*</code>) in the table <code>this_table</code> and returns it to the user. In my case, with my <code>race_data.db</code> database, I would want to execute <code>SELECT * FROM race_table</code>. So how would I do this with SQLAlchemy? This is where <code>connection</code> from Step 2 comes in.</p>
<p>The <code>connection</code> object has a method <code>.execute()</code> which can execute raw SQL queries like <code>SELECT * FROM race_table</code>. This will then return a <code>ResultProxy</code> object which can be utilized in various ways to get the data we want (based on our query). Here are some examples of how we would want our data:</p>
<ol type="1">
<li>Sometimes, we know our query will return a unique result (e.g.&nbsp;because we query based on a unique ID), so it is trivial that we want the <strong>first and only result</strong>;</li>
<li>Sometimes, we want the <strong>whole result</strong>;</li>
<li>Sometimes, we want only the <strong>top 10</strong>.</li>
</ol>
<p>Imagine processing 500k rows of data just because we want the top 10, not so efficient right? This is why we would want a two-layer process before getting our actual data, the first layer being the <code>ResultProxy</code> object. Getting the actual data from the <code>ResultProxy</code> object is simply a matter of invoking a method. For example, if we would want to get the whole result, we use the <code>.fetchall()</code> method. If we want the top 10 result, we use the <code>.fetchmany()</code> method with <code>size</code> argument set to 10. Invoking these methods returns a <code>ResultSet</code> object, which basically contains the data we want. Here is an example of a complete implementation:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> <span class="st">"SELECT * FROM race_table"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>result_proxy <span class="op">=</span> connection.execute(q)  <span class="co"># ResultProxy</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> result_proxy.fetchmany(size<span class="op">=</span><span class="dv">10</span>)  <span class="co"># ResultSet</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Querying data in Python is a two-layer process:</p>
<ol type="1">
<li>A <strong>ResultProxy</strong> gives us flexibility to access the data that we queried – do you want 1, 10 or 500k?.</li>
<li>A <strong>ResultSet</strong> contains the actual data that we queried, retrieved via a ResultProxy method.</li>
</ol>
</blockquote>
</section>
<section id="working-with-resultset" class="level3">
<h3 class="anchored" data-anchor-id="working-with-resultset">Working with ResultSet</h3>
<p>The ResultSet <code>results</code> is a <strong>list</strong> of tuples whose entries corresponds to columns in the table. Let’s get the first row in <code>results</code>. Since it is a list, we do this by accessing the zeroth element in the list via <code>row = results[0]</code>. We can print the row <strong>to get the actual data</strong>, a tuple with entries:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">(</span><span class="ex">1,</span> 88, 0.95, 1, 5, 436, <span class="st">'2013-11-03 13:19:25'</span><span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To <strong>get the column names</strong> that correspond to each entry, we can invoke <code>row.keys()</code> to get:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="ex">[</span><span class="st">'Race #'</span><span class="ex">,</span> <span class="st">'WPM'</span>, <span class="st">'Accuracy'</span>, <span class="st">'Rank'</span>, <span class="st">'# Racers'</span>, <span class="st">'Text ID'</span>, <span class="st">'Date/Time (UTC)'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we already know which column of interest we want to look at for a particular row, we can access the attribute of the row just like how we would normally do to access the value of a key in a dictionary. For example, if I’m interested in knowing the <code>Accuracy</code> of this <code>row</code>, I would just execute either <code>row.Accuracy</code> or <code>row["Accuracy"]</code> which returns <code>1</code> as expected.</p>
</section>
<section id="sqlalchemy-queries" class="level3">
<h3 class="anchored" data-anchor-id="sqlalchemy-queries">SQLAlchemy queries</h3>
<p>I know I promised that SQLAlchemy can help abstract away complex SQL queries and database differences, and using raw SQL queries like we did so far doesn’t seem to agree with this promise. Enter SQLAlchemy’s neat and Pythonic way of querying using <strong>table reflection</strong>.</p>
<p>A table reflection or just <strong>reflection</strong> is basically a process which reads the desired database, looks for your desired table and copies it into a <code>Table</code> object (see below) as if you wrote a whole raw SQL query to create this table. Personally, the term reflection is quite misleading for me and I would more prefer the term <em>autocopy</em> – because that is literally what the process does, and my philosophy is that explicit is better than nano-misleadings.</p>
<p>To make a reflection, you would need to import two classes from the <code>sqlalchemy</code> library: <code>MetaData</code> and <code>Table</code>. It is worth understanding a basic idea of what these things do:</p>
<ul>
<li>The <strong>MetaData</strong> class can be thought of a folder or catalog that keeps information about database stuffs such as tables. In this way, we don’t have to keep looking up table information because we have “organized” things nicely.</li>
<li>The <strong>Table</strong> class does exactly what you expect it to do. It stores and handles the reflected (i.e.&nbsp;autocopied) version of your desired table so that SQLAlchemy can interact with it.</li>
</ul>
<p>Now we know the required ingredients, let’s see how to actually do a table reflection. Recall that we have instantiated an <code>engine</code> and <code>connection</code> object from the previous section. We now instantiate a <code>MetaData</code> object via <code>metadata = MetaData()</code>; and then instantiate a <code>Table</code> object passing the arguments:</p>
<ol type="1">
<li>Our desired table; in my case, <code>"race_table"</code> (this is a string, cf.&nbsp;Step 3 of checking table names).</li>
<li>The instantiated <code>metadata</code>.</li>
<li>Set <code>autoload</code> to True, and put <code>autoload_with</code> our <code>engine</code>.</li>
</ol>
<p>Overall, it should look like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy <span class="im">import</span> MetaData, Table</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> MetaData()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Table reflection</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>race_table <span class="op">=</span> Table(<span class="st">"race_table"</span>, metadata, autoload<span class="op">=</span><span class="va">True</span>, autoload_with<span class="op">=</span>engine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The first thing you might want to do then is to use the <code>repr</code> function on <code>race_table</code> to learn our table’s details such as the column names together with their types such as REAL, INTEGER or TEXT. Mine returns this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> Table<span class="pp">(</span><span class="st">'race_table'</span><span class="ss">, MetaData</span><span class="pp">(</span><span class="ss">bind=None</span><span class="pp">)</span><span class="ss">, Column</span><span class="pp">(</span><span class="st">'Race #'</span><span class="ss">, INTEGER</span><span class="pp">()</span><span class="ss">, table=&lt;race_table&gt;</span><span class="pp">)</span><span class="ss">, Column</span><span class="pp">(</span><span class="st">'WPM'</span><span class="ss">, INTEGER</span><span class="pp">()</span><span class="ss">, table=&lt;race_table&gt;</span><span class="pp">)</span><span class="ss">, Column</span><span class="pp">(</span><span class="st">'Accuracy'</span><span class="ss">, REAL</span><span class="pp">()</span><span class="ss">, table=&lt;race_table&gt;</span><span class="pp">)</span><span class="ss">, Column</span><span class="pp">(</span><span class="st">'Rank'</span><span class="ss">, INTEGER</span><span class="pp">()</span><span class="ss">, table=&lt;race_table&gt;</span><span class="pp">)</span><span class="ss">, Column</span><span class="pp">(</span><span class="st">'# Racers'</span><span class="ss">, INTEGER</span><span class="pp">()</span><span class="ss">, table=&lt;race_table&gt;</span><span class="pp">)</span><span class="ss">, Column</span><span class="pp">(</span><span class="st">'Text ID'</span><span class="ss">, INTEGER</span><span class="pp">()</span><span class="ss">, table=&lt;race_table&gt;</span><span class="pp">)</span><span class="ss">, Column</span><span class="pp">(</span><span class="st">'Date/Time (UTC)'</span><span class="ss">, TEXT</span><span class="pp">()</span><span class="ss">, table=&lt;race_table&gt;</span><span class="pp">)</span><span class="ss">, schema=None</span><span class="pp">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The true power of the SQLAlchemy way of querying comes now. To replicate our raw SQL query of <code>SELECT * FROM race_table</code>, we can import and use the <code>select</code> function from the <code>sqlalchemy</code> library. The <code>select</code> function can take a (list of) <code>Table</code> object to select all the rows in that table. The equivalent query to <code>SELECT * FROM race_table</code> is then <code>select([race_table])</code>. More completely, we execute the following code:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> select([race_table])</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>result_proxy <span class="op">=</span> connection.execute(q)  <span class="co"># ResultProxy</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> result_proxy.fetchmany(size<span class="op">=</span><span class="dv">10</span>)  <span class="co"># ResultSet</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Observe that the last two lines are identical as to when we were writing raw SQL queries, the only difference being the first line. Hence, the way we access <code>results</code> is exactly the same as we’ve discussed earlier. For the SELECT query, it might be trivial to use the <code>select</code> function but you can imagine that when the queries gets more complex, this will be really nice and clean. Note that you can get the raw SQL query of <code>q</code> by simply printing it to the console.</p>
<p><strong>References</strong></p>
<ul>
<li>[1] <em>Introduction to Databases in Python</em>, DataCamp</li>
<li>[2] <a href="https://stackoverflow.com/a/44098950/13698939"><em>Sam Hartman’s Answer to Understanding MetaData() from SQLAlchemy in Python</em></a>, Stack Overflow</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>